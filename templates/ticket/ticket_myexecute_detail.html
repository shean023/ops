{% extends "base.html" %}
{% load staticfiles %}
{% block head %}

    <link rel="stylesheet" href="{% static 'jquery-confirm/dist/jquery-confirm.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'dist/css/xcConfirm.css' %}"/>
    <style>


        .label-yellow, .badge-yellow {
            background-color: #fee188 !important
        }

        .badge-yellow, .label-yellow {
            color: #963 !important;
            border-color: #fee188
        }

        .label.arrowed, .label.arrowed-in {
            position: relative;
            z-index: 1
        }

        .label.arrowed:before, .label.arrowed-in:before {
            display: inline-block;
            content: "";
            position: absolute;
            top: 0;
            z-index: -1;
            border: 1px solid transparent;
            border-right-color: #abbac3
        }

        .label.arrowed-in:before {
            border-color: #abbac3;
            border-left-color: transparent !important
        }

        .label.arrowed-right, .label.arrowed-in-right {
            position: relative;
            z-index: 1
        }

        .label.arrowed-right:after, .label.arrowed-in-right:after {
            display: inline-block;
            content: "";
            position: absolute;
            top: 0;
            z-index: -1;
            border: 1px solid transparent;
            border-left-color: #abbac3
        }

        .label.arrowed-in-right:after {
            border-color: #abbac3;
            border-right-color: transparent !important
        }

        .label-passby, .badge-success {
            background-color: #82af6f !important
        }

        .label-passby.arrowed:before {
            border-right-color: #82af6f
        }

        .label-passby.arrowed-in:before {
            border-color: #82af6f
        }

        .label-passby.arrowed-right:after {
            border-left-color: #82af6f
        }

        .label-passby.arrowed-in-right:after {
            border-color: #82af6f
        }

        .label-yellow.arrowed:before {
            border-right-color: #fee188
        }

        .label-yellow.arrowed-in:before {
            border-color: #fee188
        }

        .label-yellow.arrowed-right:after {
            border-left-color: #fee188
        }

        .label-yellow.arrowed-in-right:after {
            border-color: #fee188
        }


        .label {
            font-size: 12px;
            line-height: 1.15;
            height: 20px
        }

        .label.arrowed {
            margin-left: 5px
        }

        .label.arrowed:before {
            left: -10px;
            border-width: 10px 5px
        }

        .label.arrowed-in {
            margin-left: 5px
        }

        .label.arrowed-in:before {
            left: -5px;
            border-width: 10px 5px
        }

        .label.arrowed-right {
            margin-right: 5px
        }

        .label.arrowed-right:after {
            right: -10px;
            border-width: 10px 5px
        }

        .label.arrowed-in-right {
            margin-right: 5px
        }

        .label.arrowed-in-right:after {
            right: -5px;
            border-width: 10px 5px
        }

        .profile-activity {
            padding: 10px 4px;
            border-bottom: 1px dotted #d0d8e0;
            position: relative;
            border-left: 1px dotted #FFF;
            border-right: 1px dotted #FFF
        }

        .clearfix:before, .clearfix:after {
            display: table;
            content: " "
        }

        .profile-activity .thumbicon {
            background-color: #74abd7;
            display: inline-block;
            border-radius: 100%;
            width: 38px;
            height: 38px;
            color: #FFF;
            font-size: 18px;
            text-align: center;
            line-height: 38px;
            margin-right: 10px;
            margin-left: 0;
            text-shadow: none !important
        }

        .btn-info, .btn-info:focus {
            background-color: #6fb3e0 !important;
            border-color: #6fb3e0
        }

        .btn-yellow {
            color: #963 !important;
            text-shadow: 0 -1px 0 rgba(255, 255, 255, 0.4) !important
        }

        .btn-yellow, .btn-yellow:focus {
            background-color: #fee188 !important;
            border-color: #fee188
        }


        .btn-sm {
            border-width: 4px;
            font-size: 13px;
            padding: 4px 9px;
            line-height: 1.39
        }

        .col-sm-2 {
            width: 16.6666%
        }

        .no-padding-right {
            padding-right: 0 !important
        }


        .row:before, .row:after {
            display: table;
            content: " "
        }

        .row:after {
            clear: both
        }

        .form-horizontal .form-group:before, .form-horizontal .form-group:after {
            display: table;
            content: " "
        }


        .modal-footer:before, .modal-footer:after {
            display: table;
            content: " "
        }

        .modal-footer:after {
            clear: both
        }

    </style>

{% endblock %}
{% block content %}

    <!-- Main row -->
    <div class="row">
        <!-- Left col -->
        <div class="col-md-12">

            <!-- TABLE: LATEST ORDERS -->
            <div class="box box-info">
                <div class="box-header with-border">
                    <h3 class="box-title">基本信息</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="box-body">
                    <!-- 工单标题 基本信息-->
                    <div class="row">
                        <div class="space-4"></div>
                        <div class="space-4"></div>
                        <div class="space-4"></div>
                        <div class="space-4"></div>
                        <!--工单header-->
                        <div class="col-xs-12 col-sm-12">
                            <div class="table-responsive">
                                <table id="sample-table-1" class="table table-bordered">

                                    <tbody>
                                    <tr>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>标题</b></td>
                                        <td style="width:50%;">{{ detailData.ticket_title }}</td>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>创建者</b></td>
                                        <td>{{ detailData.ticket_createuser }}</td>
                                    </tr>
                                    <tr>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>工单号</b></td>
                                        <td style="width:50%;">{{ detailData.ticket_id }}</td>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>创建时间</b></td>
                                        <td>{{ detailData.ticket_ctime|date:"Y/m/d H:i  " }}</td>
                                    </tr>
                                    <tr>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>工单类型</b></td>
                                        <td style="width:50%;">{{ detailData.ticket_type }}</td>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>操作</b></td>
                                        <td>
                                            <div class="btn-group">
                                                {% if detailData.ticket_status == 3 %}
                                                    <button class="btn btn-sm btn-success"
                                                            onclick="TicketExecute('ExecOK', {{ detailData.ticket_id }});">
                                                        确认执行
                                                    </button>
                                                    <button class="btn btn-sm btn-warning"
                                                            onclick="TicketExecute('ExecNO', {{ detailData.ticket_id }});">
                                                        驳回申请
                                                    </button>
                                                    <button class="btn btn-sm btn-info" data-toggle="modal"
                                                            data-target="#modalTicketForwarding"
                                                            onclick="TicketExecute('ExecForwarding', {{ detailData.ticket_id }});">
                                                        转发处理
                                                    </button>
                                                {% endif %}
                                            </div>

                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>流程状态</b></td>
                                        <td style="width:50%">
                                            {#                                        <td colspan="3">#}
                                            <span class="label label-passby arrowed-right arrowed-in">{{ detailData.ticket_createuser }}</span>
                                            <!--<i class="icon-arrow-right icon-on-right"></i>-->
                                            {% for audituser in detailData.audit_user %}

                                                {% if audituser.status == 0 %}
                                                    <span class="label label-yellow arrowed-right arrowed-in">{{ audituser.name }}</span>
                                                {% else %}
                                                    <span class="label label-passby arrowed-right arrowed-in">{{ audituser.name }}</span>
                                                {% endif %}
                                                <!--<i class="icon-arrow-right icon-on-right"></i>-->
                                            {% endfor %}
                                            {% for execuser in detailData.exec_user %}
                                                {% if execuser.status == 0 %}
                                                    <span class="label label-yellow arrowed-right arrowed-in">{{ execuser.name }}</span>
                                                {% else %}
                                                    <span class="label label-passby arrowed-right arrowed-in">{{ execuser.name }}</span>
                                                {% endif %}
                                                <!--<i class="icon-arrow-right icon-on-right"></i>-->
                                            {% endfor %}
                                            {% if detailData.ticket_status < 10 %}
                                                <span class="label label-yellow arrowed-right arrowed-in">{{ detailData.ticket_createuser }}</span>
                                            {% else %}
                                                <span class="label label-passby arrowed-right arrowed-in">{{ detailData.ticket_createuser }}</span>
                                            {% endif %}
                                        </td>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>工单状态</b></td>
                                        <td><span
                                                class="label label-passby ">{{ detailData.ticket_status_label }}</span>
                                        </td>

                                    </tr>
                                    </tbody>
                                </table>

                            </div><!-- /.table-responsive -->
                        </div><!-- /span -->
                    </div>

                    <div class="modal fade bs-example-modal-sm" style="grid-auto-rows: auto" id="modalTicketForwarding"
                         name="modalTicketForwarding" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
                         aria-hidden="true">
                        <div class="modal-dialog modaal-sm">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                        &times;
                                    </button>
                                    <input type="hidden" id="ticketid" name="ticketid" value="0"/>
                                    <h4 class="modal-title" id="myLargeModalLabel">转发执行</h4>
                                </div>

                                <div class="modal-body">
                                    <div class="row">
                                        <form class="form-horizontal">
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label no-padding-right"
                                                       for="firstexecutor"> 转发至 </label>
                                                <div class="col-sm-9">
                                                <span>
                                                    <select class="form-control select2" name="firstexecutor"
                                                            id="firstexecutor"
                                                            style="width:145px">
                                                    </select>
                                                </span>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div> <!-- END -->

                                <div class="modal-footer">
                                    <button class="btn btn-info" id="submit" name="submit"
                                            onclick="sureExecForwarding();">
                                        <i class="glyphicon glyphicon-ok"></i>
                                        确定
                                    </button>
                                    &nbsp; &nbsp; &nbsp;
                                    <button type="button" class="btn btn-default" data-dismiss="modal">
                                        <i class="glyphicon glyphicon-remove"></i>
                                        取消
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div><!-- /.modal -->
                </div>
                <!-- /.box -->
            </div>
            <!-- /.col -->
        </div>
    </div>
    <!-- /.row -->

    <div class="row">
        <!-- 工单详情 -->
        <div class="col-md-12">
            <div class="box box-info">


                <div class="box-header with-border">
                    <h3 class="box-title">详情</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="box-body">
                    <!--工单详情-->
                    <div class="col-xs-12 col-sm-12">
                        <div class="widget-body">
                            <div class="widget-main">

                                <div class="form-horizontal">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label no-padding-right"
                                               for="ticketrequire"> 需求 </label>

                                        <div class="col-sm-9">

                                                <textarea id="ticketrequire" name="ticketrequire"
                                                          class="col-xs-9 col-sm-8" placeholder="请输入你的需求"
                                                          readonly="true">{{ detailData.ticket_content }}</textarea>
                                        </div>
                                    </div>

                                    <div class="space-4"></div>
                                    {% if detailData.ticket_status == 4 or detailData.ticket_status == 5 or detailData.ticket_status == 9 %}
                                        <div class="form-group">
											<label class="col-sm-3 control-label no-padding-right " for="ticketresult"> 结果 </label>

											<div class="col-sm-9">
												<textarea id="ticketresult" name="ticketresult" class="col-xs-10 col-sm-8"  placeholder="请输入结果">{{ detailData.ticket_result }}</textarea>
											</div>
										</div>

										<div class="space-4"></div>
                                        <div class="clearfix form-actions">
                                            <div class="col-md-offset-3 col-md-9">
                                                <button class="btn btn-info" type="submit" id="submit"
                                                        name="submit"
                                                        onclick="TicketExecute('execComplete', {{ detailData.ticket_id }});">
                                                    <i class="glyphicon glyphicon-ok"></i>
                                                    确认完成
                                                </button>

                                                &nbsp; &nbsp; &nbsp;
                                                <button class="btn btn-yellow" type="save" id="save"
                                                        name="save"
                                                        onclick="TicketExecute('execSave', {{ detailData.ticket_id }});">
                                                    <i class="glyphicon glyphicon-hdd"></i>
                                                    保存
                                                </button>
                                            </div>
                                        </div>
                                    {% elif detailData.ticket_status == 6 %}
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label no-padding-right "
                                                   for="ticketresult"> 结果 </label>

                                            <div class="col-sm-9">
                                                        <textarea id="ticketresult" name="ticketresult"
                                                                  class="col-xs-10 col-sm-8" placeholder="请输入结果"
                                                                  readonly="true">{{ detailData.ticket_result }}</textarea>
                                            </div>
                                        </div>

                                    {% endif %}

                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- /span -->

            </div><!-- /.row -->
        </div>

    </div>

    <div class="row">
        <!-- 工单操作记录 -->
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header with-border">
                    <h3 class="box-title">操作记录</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <!--操作记录-->
                    <div class="widget-body">
                        <div class="widget-main padding-8">
                            <div id="profile-feed-1" class="profile-feed">

                                {% for operationUser in detailData.operation_user %}
                                    <div class="profile-activity clearfix">
                                        <div>
                                            <ul class="control-sidebar-menu" id="user-list" style="margin-left: 0">
                                                <a href="javascript:void(0)">
                                                    {% if operationUser.login_status == 0 %}
                                                        <img src="{{ MEDIA_URL }}{{ operationUser.user_image }}"
                                                             class="menu-icon"
                                                             alt="User Image"
                                                             style="border: 2px solid #00a65a;">
                                                    {% elif operationUser.login_status == 1 %}
                                                        <img src="{{ MEDIA_URL }}{{ operationUser.user_image }}"
                                                             class="menu-icon"
                                                             alt="User Image"
                                                             style="border: 2px solid #ff0000;">
                                                    {% elif operationUser.login_status == 2 %}
                                                        <img src="{{ MEDIA_URL }}{{ operationUser.user_image }}"
                                                             class="menu-icon"
                                                             alt="User Image"
                                                             style="border: 2px solid #FFFF00;">
                                                    {% elif operationUser.login_status == 3 %}
                                                        <img src="{{ MEDIA_URL }}{{ operationUser.user_image }}"
                                                             class="menu-icon"
                                                             alt="User Image"
                                                             style="border: 2px solid #808080;">
                                                    {% endif %}
                                                </a>
                                            </ul>
                                            {{ operationUser.ctime|date:"Y/m/d H:i  " }}
                                            <a class="user" href="#">{{ operationUser.name }}</a>
                                            {{ operationUser.operation_type }}

                                            <div style='width: auto;display:block;word-break: break-all;word-wrap: break-word;'>
                                                {{ operationUser.content }}
                                            </div>
                                            {#                                             <div class="time">#}
                                            {#                                                <i class="icon-time bigger-110"></i>#}
                                            {#                                                5 ago#}
                                            {#                                            </div>#}
                                        </div>

                                        <!--
                                        <div class="tools action-buttons">
                                            <a href="#" class="blue">
                                                <i class="icon-pencil bigger-125"></i>
                                            </a>

                                            <a href="#" class="red">
                                                <i class="icon-remove bigger-125"></i>
                                            </a>
                                        </div> -->
                                    </div>
                                {% endfor %}
                            </div>

                            <form>
                                <div class="form-actions">
                                    <div class="input-group">
                                        <input placeholder="在这里输入你的消息 ..." type="text" class="form-control"
                                               id="message" name="message"/>
                                        <span class="input-group-btn">
													<button class="btn btn-sm btn-info no-radius" type="button"
                                                            onclick="TicketExecute('sendmsg', {{ detailData.ticket_id }});">
                                                        <i class="icon ion-ios-redo"></i>
														发送
													</button>
                                        </span>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}
    <script src="{% static 'dist/js/xcConfirm.js' %}" type="text/javascript" charset="utf-8"></script>
    <script src="{% static 'jquery-confirm/dist/jquery-confirm.min.js' %}"></script>

    <script>

        function TicketExecute(type, ticketid) {
            if (type === 'sendmsg') {
                const var_message = $("#message").val();
                if (var_message === '') {
                    window.wxc.xcConfirm("请填写回复内容!", window.wxc.xcConfirm.typeEnum.error);
                    $("#var_message").focus();
                    return false;
                }

                $.ajax({
                    url: '/ticket/ticket_mycreate/',
                    type: "POST",
                    dataType: "json",
                    data: {
                        'type': "sendMessage",
                        'message': var_message,
                        'ticketid': ticketid
                    },
                    success: function (response) {
                        if (response["code"] == "200") {
                            //window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
                            window.location.href = "/ticket/ticket_execute/?type=detail&mtid=" + ticketid

                        } else {
                            window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
                        }
                    },
                    error: function (response) {
                        window.wxc.xcConfirm("请求数据错误,请联系管理员！", window.wxc.xcConfirm.typeEnum.error);
                    },
                });

            } else if (type === 'ExecOK') {

                $.ajax({
                    url: '/ticket/ticket_execute/',
                    type: "POST",
                    dataType: "json",
                    data: {
                        'type': type,
                        'ticketid': ticketid,
                    },
                    success: function (response) {
                        if (response["code"] == "200") {
                            //window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
                            window.location.href = "/ticket/ticket_execute/";

                        } else {
                            window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
                        }
                    },
                    error: function (response) {
                        window.wxc.xcConfirm("请求数据错误,请联系管理员！", window.wxc.xcConfirm.typeEnum.error);
                    },
                });

            } else if (type === 'ExecNO') {

                $.ajax({
                    url: '/ticket/ticket_execute/',
                    type: "POST",
                    dataType: "json",
                    data: {
                        'type': type,
                        'ticketid': ticketid,
                    },
                    success: function (response) {
                        if (response["code"] == "200") {
                            //window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
                            window.location.href = "/ticket/ticket_execute/";

                        } else {
                            window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
                        }
                    },
                    error: function (response) {
                        window.wxc.xcConfirm("请求数据错误,请联系管理员！", window.wxc.xcConfirm.typeEnum.error);
                    },
                });

            } else if (type === 'ExecForwarding') {

                document.getElementById('ticketid').value = ticketid;
                getCheckLeader();

            } else if (type === 'execComplete' || type === 'execSave') {

                const var_ticketresult = $("#ticketresult").val();
                $.ajax({
                    url: '/ticket/ticket_execute/',
                    type: "POST",
                    dataType: "json",
                    data: {
                        'type': type,
                        'ticketresult': var_ticketresult,
                        'ticketid': ticketid,
                    },
                    success: function (response) {
                        if (response["code"] == "200") {
                            //window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
                            if (type === 'execSave') {
                                window.location.href = "/ticket/ticket_execute/?type=detail&mtid=" + ticketid;
                            } else {
                                window.location.href = "/ticket/ticket_execute/";
                            }


                        } else {
                            window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
                        }
                    },
                    error: function (response) {
                        window.wxc.xcConfirm("请求数据错误,请联系管理员！", window.wxc.xcConfirm.typeEnum.error);
                    },
                });

            }
        }

        function sureExecForwarding() {
            const ticketid = $("#ticketid").val();
            const switchExecutor_val = $("#firstexecutor").find("option:selected").val();

            if (switchExecutor_val == '0') {
                window.wxc.xcConfirm("请选择执行人", window.wxc.xcConfirm.typeEnum.error);
                $("#firstexecutor").focus();
                return false;
            }

            $.ajax({
                url: '/ticket/ticket_execute/',
                type: "POST",
                dataType: "json",
                data: {
                    'type': 'ExecForwarding',
                    'ticketid': ticketid,
                    'executor_id': switchExecutor_val
                },
                success: function (response) {
                    if (response["code"] == "200") {
                        //window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
                        window.location.href = "/ticket/ticket_execute/?type=detail&mtid=" + ticketid;

                    } else {
                        window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
                    }
                },
                error: function (response) {
                    window.wxc.xcConfirm("请求数据错误,请联系管理员！", window.wxc.xcConfirm.typeEnum.error);
                },
            });

        }

        // 获取审核人名单,设置(指定审核人)下拉选择框
        function getCheckLeader() {
            $.ajax({
                url: '/users/get_user/',
                type: "POST",
                dataType: "json",
                data: {'oper': "getUsers"},
                error: function () {
                    $("#firstexecutor").html('<option value="0" >--选择执行人--</option>');
                },
                success: function (data) {

                    var oplist = new Array();
                    for (key_num in data['data']) {
                        oplist.push('<option value="' + data['data'][key_num]['id'] + '">' + data['data'][key_num]['cnname'] + '(' + data['data'][key_num]['name'] + ')</option>');
                    }

                    $("#firstexecutor").html('<option value="0" >--选择执行人--</option>' + oplist.join(''));
                    oplist = null;
                }
            });
        }

        //关闭 modalTicketForwarding 时触发
        $('#modalTicketForwarding').on('hide.bs.modal', function (e) {
            document.getElementById('ticketid').value = "0";
            $("#firstexecutor").empty();
        })
    </script>

{% endblock %}