{% extends "base.html" %}
{% load staticfiles %}
{% block head %}

    <link rel="stylesheet" href="{% static 'jquery-confirm/dist/jquery-confirm.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'dist/css/xcConfirm.css' %}"/>

    <!-- ace styles -->
    <style>


        .label-yellow, .badge-yellow {
            background-color: #fee188 !important
        }

        .badge-yellow, .label-yellow {
            color: #963 !important;
            border-color: #fee188
        }

        .label.arrowed, .label.arrowed-in {
            position: relative;
            z-index: 1
        }

        .label.arrowed:before, .label.arrowed-in:before {
            display: inline-block;
            content: "";
            position: absolute;
            top: 0;
            z-index: -1;
            border: 1px solid transparent;
            border-right-color: #abbac3
        }

        .label.arrowed-in:before {
            border-color: #abbac3;
            border-left-color: transparent !important
        }

        .label.arrowed-right, .label.arrowed-in-right {
            position: relative;
            z-index: 1
        }

        .label.arrowed-right:after, .label.arrowed-in-right:after {
            display: inline-block;
            content: "";
            position: absolute;
            top: 0;
            z-index: -1;
            border: 1px solid transparent;
            border-left-color: #abbac3
        }

        .label.arrowed-in-right:after {
            border-color: #abbac3;
            border-right-color: transparent !important
        }

        .label-passby, .badge-success {
            background-color: #82af6f !important
        }

        .label-passby.arrowed:before {
            border-right-color: #82af6f
        }

        .label-passby.arrowed-in:before {
            border-color: #82af6f
        }

        .label-passby.arrowed-right:after {
            border-left-color: #82af6f
        }

        .label-passby.arrowed-in-right:after {
            border-color: #82af6f
        }

        .label-yellow.arrowed:before {
            border-right-color: #fee188
        }

        .label-yellow.arrowed-in:before {
            border-color: #fee188
        }

        .label-yellow.arrowed-right:after {
            border-left-color: #fee188
        }

        .label-yellow.arrowed-in-right:after {
            border-color: #fee188
        }


        .label {
            font-size: 12px;
            line-height: 1.15;
            height: 20px
        }

        .label.arrowed {
            margin-left: 5px
        }

        .label.arrowed:before {
            left: -10px;
            border-width: 10px 5px
        }

        .label.arrowed-in {
            margin-left: 5px
        }

        .label.arrowed-in:before {
            left: -5px;
            border-width: 10px 5px
        }

        .label.arrowed-right {
            margin-right: 5px
        }

        .label.arrowed-right:after {
            right: -10px;
            border-width: 10px 5px
        }

        .label.arrowed-in-right {
            margin-right: 5px
        }

        .label.arrowed-in-right:after {
            right: -5px;
            border-width: 10px 5px
        }

        .profile-activity {
            padding: 10px 4px;
            border-bottom: 1px dotted #d0d8e0;
            position: relative;
            border-left: 1px dotted #FFF;
            border-right: 1px dotted #FFF
        }

        .clearfix:before, .clearfix:after {
            display: table;
            content: " "
        }

        .profile-activity .thumbicon {
            background-color: #74abd7;
            display: inline-block;
            border-radius: 100%;
            width: 38px;
            height: 38px;
            color: #FFF;
            font-size: 18px;
            text-align: center;
            line-height: 38px;
            margin-right: 10px;
            margin-left: 0;
            text-shadow: none !important
        }

        .btn-info, .btn-info:focus {
            background-color: #6fb3e0 !important;
            border-color: #6fb3e0
        }

        .btn-yellow {
            color: #963 !important;
            text-shadow: 0 -1px 0 rgba(255, 255, 255, 0.4) !important
        }

        .btn-yellow, .btn-yellow:focus {
            background-color: #fee188 !important;
            border-color: #fee188
        }

        .btn-sm {
            border-width: 4px;
            font-size: 13px;
            padding: 4px 9px;
            line-height: 1.39
        }


    </style>

{% endblock %}
{% block content %}

    <!-- Main row -->
    <div class="row">
        <!-- Left col -->
        <div class="col-md-12">

            <!-- TABLE: LATEST ORDERS -->
            <div class="box box-info">


                <div class="box-header with-border">
                    <h3 class="box-title">基本信息</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="box-body">
                    <!-- 工单标题 基本信息-->
                    <div class="row">
                        <div class="space-4"></div>
                        <div class="space-4"></div>
                        <div class="space-4"></div>
                        <div class="space-4"></div>
                        <!--工单header-->
                        <div class="col-xs-12 col-sm-12">
                            <div class="table-responsive">
                                <table id="sample-table-1" class="table table-bordered">

                                    <tbody>
                                    <tr>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>标题</b></td>
                                        <td style="width:50%;">{{ detailData.ticket_title }}</td>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>创建者</b></td>
                                        <td>{{ detailData.ticket_createuser }}</td>
                                    </tr>
                                    <tr>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>工单号</b></td>
                                        <td style="width:50%;">{{ detailData.ticket_id }}</td>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>创建时间</b></td>
                                        <td>{{ detailData.ticket_ctime|date:"Y/m/d H:i  " }}</td>
                                    </tr>
                                    <tr>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>工单类型</b></td>
                                        <td style="width:50%;">{{ detailData.ticket_type }}</td>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>操作</b></td>
                                        <td>
                                            <div class="btn-group">
                                                {% if detailData.ticket_status < 3 %}
                                                    {% if detailData.ticket_status > 1 and detailData.ticket_status < 3 %}
                                                        <button class="btn btn-sm btn-warning" id="check_ticket"
                                                                onclick="MyTicket('operTicket', {{ detailData.ticket_id }}, 'revoketicket');">
                                                            撤回工单
                                                        </button>
                                                    {% endif %}
                                                    <button class="btn btn-sm btn-danger" id="check_ticket"
                                                            onclick="MyTicket('operTicket', {{ detailData.ticket_id }}, 'deleteticket');">
                                                        删除工单
                                                    </button>
                                                {% endif %}
                                            </div>

                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>流程状态</b></td>
                                        <td style="width:50%">
                                            {#                                        <td colspan="3">#}
                                            <span class="label label-passby arrowed-right arrowed-in">{{ detailData.ticket_createuser }}</span>
                                            <!--<i class="icon-arrow-right icon-on-right"></i>-->
                                            {% for audituser in detailData.audit_user %}

                                                {% if audituser.status == 0 %}
                                                    <span class="label label-yellow arrowed-right arrowed-in">{{ audituser.name }}</span>
                                                {% else %}
                                                    <span class="label label-passby arrowed-right arrowed-in">{{ audituser.name }}</span>
                                                {% endif %}
                                                <!--<i class="icon-arrow-right icon-on-right"></i>-->
                                            {% endfor %}
                                            {% for execuser in detailData.exec_user %}
                                                {% if execuser.status == 0 %}
                                                    <span class="label label-yellow arrowed-right arrowed-in">{{ execuser.name }}</span>
                                                {% else %}
                                                    <span class="label label-passby arrowed-right arrowed-in">{{ execuser.name }}</span>
                                                {% endif %}
                                                <!--<i class="icon-arrow-right icon-on-right"></i>-->
                                            {% endfor %}
                                            {% if detailData.ticket_status < 10 %}
                                                <span class="label label-yellow arrowed-right arrowed-in">{{ detailData.ticket_createuser }}</span>
                                            {% else %}
                                                <span class="label label-passby arrowed-right arrowed-in">{{ detailData.ticket_createuser }}</span>
                                            {% endif %}
                                        </td>
                                        <td style="width:8%;" bgcolor='#b5bbed'><b>工单状态</b></td>
                                        <td><span
                                                class="label label-passby ">{{ detailData.ticket_status_label }}</span>
                                        </td>

                                    </tr>
                                    </tbody>
                                </table>

                            </div><!-- /.table-responsive -->
                        </div><!-- /span -->
                    </div>
                </div>
                <!-- /.box -->
            </div>
            <!-- /.col -->
        </div>
    </div>
    <!-- /.row -->

    <div class="row">
        <!-- 工单详情 -->
        <div class="col-md-12">
            <div class="box box-info">


                <div class="box-header with-border">
                    <h3 class="box-title">详情</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="box-body">
                    <!--工单详情-->
                    <div class="col-xs-12 col-sm-12">
                        <div class="widget-body">
                            <div class="widget-main">

                                <div class="form-horizontal">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label no-padding-right"
                                               for="ticketrequire"> 需求 </label>

                                        <div class="col-sm-9">
                                            {% if detailData.ticket_status == 1 or detailData.ticket_status == 7 or detailData.ticket_status == 8 %}
                                                <textarea id="ticketrequire" name="ticketrequire"
                                                          class="col-xs9 col-sm-8"
                                                          placeholder="请输入你的需求">{{ detailData.ticket_content }}</textarea>
                                            {% else %}
                                                <textarea id="ticketrequire" name="ticketrequire"
                                                          class="col-xs-9 col-sm-8" placeholder="请输入你的需求"
                                                          readonly="true">{{ detailData.ticket_content }}</textarea>
                                            {% endif %}
                                        </div>
                                    </div>


                                    {% if detailData.ticket_status == 1 or detailData.ticket_status == 7 or detailData.ticket_status == 8 %}
                                        <div class="clearfix form-actions">
                                            <div class="col-md-offset-3 col-md-9">

                                                <button class="btn btn-info" type="submit" id="submit"
                                                        name="submit"
                                                        onclick="MyTicket('editTicket', {{ detailData.ticket_id }}, 'submit');">
                                                    <i class="icon-ok bigger-110"></i>
                                                    提交
                                                </button>

                                                &nbsp; &nbsp; &nbsp;
                                                <button class="btn btn-yellow" type="save" id="save"
                                                        name="save"
                                                        onclick="MyTicket('editTicket', {{ detailData.ticket_id }}, 'save');">
                                                    <i class=" icon-hdd bigger-110"></i>
                                                    保存
                                                </button>

                                                &nbsp; &nbsp; &nbsp;
                                                <button class="btn btn-info" type="submit" id="close"
                                                        name="close"
                                                        onclick="MyTicket('editTicket', {{ detailData.ticket_id }}, 'close');">
                                                    <i class="icon-ok bigger-110"></i>
                                                    关闭工单
                                                </button>
                                            </div>
                                        </div>
                                    {% elif detailData.ticket_status == 6 %}
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label no-padding-right "
                                                   for="ticketresult"> 结果 </label>

                                            <div class="col-sm-9">
                                                        <textarea id="ticketresult" name="ticketresult"
                                                                  class="col-xs-10 col-sm-8" placeholder="请输入结果"
                                                                  readonly="true">{{ detailData.ticket_result }}</textarea>
                                            </div>
                                        </div>
                                        <div class="space-4"></div>
                                        <div class="clearfix form-actions">
                                            <div class="col-md-offset-3 col-md-9">

                                                <button class="btn btn-info" type="submit" id="close"
                                                        name="close"
                                                        onclick="MyTicket('editTicket', {{ detailData.ticket_id }}, 'close');">
                                                    <i class="icon-ok bigger-110"></i>
                                                    关闭工单
                                                </button>

                                                &nbsp; &nbsp; &nbsp;
                                                <button class="btn btn-yellow" type="submit" id="reset"
                                                        name="reset"
                                                        onclick="MyTicket('editTicket', {{ detailData.ticket_id }}, 'reset');">
                                                    <i class="icon-undo bigger-110"></i>
                                                    执行重做
                                                </button>

                                            </div>
                                        </div>
                                    {% endif %}

                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- /span -->

            </div><!-- /.row -->
        </div>

    </div>

    <div class="row">
        <!-- 工单操作记录 -->
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header with-border">
                    <h3 class="box-title">操作记录</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <!--操作记录-->
                    <div class="widget-body">
                        <div class="widget-main padding-8">
                            <div id="profile-feed-1" class="profile-feed">

                                {% for operationUser in detailData.operation_user %}
                                    <div class="profile-activity clearfix">
                                        <div>
                                            <ul class="control-sidebar-menu" id="user-list" style="margin-left: 0">
                                                <a href="javascript:void(0)">
                                                    {% if operationUser.login_status == 0 %}
                                                        <img src="{{ MEDIA_URL }}{{ operationUser.user_image }}"
                                                             class="menu-icon"
                                                             alt="User Image"
                                                             style="border: 2px solid #00a65a;">
                                                    {% elif operationUser.login_status == 1 %}
                                                        <img src="{{ MEDIA_URL }}{{ operationUser.user_image }}"
                                                             class="menu-icon"
                                                             alt="User Image"
                                                             style="border: 2px solid #ff0000;">
                                                    {% elif operationUser.login_status == 2 %}
                                                        <img src="{{ MEDIA_URL }}{{ operationUser.user_image }}"
                                                             class="menu-icon"
                                                             alt="User Image"
                                                             style="border: 2px solid #FFFF00;">
                                                    {% elif operationUser.login_status == 3 %}
                                                        <img src="{{ MEDIA_URL }}{{ operationUser.user_image }}"
                                                             class="menu-icon"
                                                             alt="User Image"
                                                             style="border: 2px solid #808080;">
                                                    {% endif %}
                                                </a>
                                            </ul>
                                            {{ operationUser.ctime|date:"Y/m/d H:i  " }}
                                            <a class="user" href="#">{{ operationUser.name }}</a>
                                            {{ operationUser.operation_type }}

                                            <div style='width: auto;display:block;word-break: break-all;word-wrap: break-word;'>
                                                {{ operationUser.content }}
                                            </div>
                                            {#                                             <div class="time">#}
                                            {#                                                <i class="icon-time bigger-110"></i>#}
                                            {#                                                5 ago#}
                                            {#                                            </div>#}
                                        </div>

                                        <!--
                                        <div class="tools action-buttons">
                                            <a href="#" class="blue">
                                                <i class="icon-pencil bigger-125"></i>
                                            </a>

                                            <a href="#" class="red">
                                                <i class="icon-remove bigger-125"></i>
                                            </a>
                                        </div> -->
                                    </div>
                                {% endfor %}
                            </div>

                            <form>
                                <div class="form-actions">
                                    <div class="input-group">
                                        <input placeholder="在这里输入你的消息 ..." type="text" class="form-control"
                                               id="message" name="message"/>
                                        <span class="input-group-btn">
													<button class="btn btn-sm btn-info no-radius" type="button"
                                                            onclick="MyTicket('sendmsg', {{ detailData.ticket_id }}, '');">
                                                        <i class="icon ion-ios-redo"></i>
														发送
													</button>
                                        </span>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}
    <script src="{% static 'dist/js/xcConfirm.js' %}" type="text/javascript" charset="utf-8"></script>
    <script src="{% static 'jquery-confirm/dist/jquery-confirm.min.js' %}"></script>

    <script>

        function MyTicket(type, ticketid, action) {
            if (type === 'sendmsg') {
                const var_message = $("#message").val();
                if (var_message === '') {
                    window.wxc.xcConfirm("请填写回复内容!", window.wxc.xcConfirm.typeEnum.error);
                    $("#var_message").focus();
                    return false;
                }

                $.ajax({
                    url: '/ticket/ticket_mycreate/',
                    type: "POST",
                    dataType: "json",
                    data: {
                        'type': "sendMessage",
                        'message': var_message,
                        'ticketid': ticketid
                    },
                    success: function (response) {
                        if (response["code"] == "200") {
                            //window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
                            window.location.href = "/ticket/ticket_mycreate/?type=detail&mtid=" + ticketid

                        } else {
                            window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
                        }
                    },
                    error: function (response) {
                        window.wxc.xcConfirm("请求数据错误！", window.wxc.xcConfirm.typeEnum.error);
                    },
                });

            } else if (type === 'editTicket') {
                const var_ticketrequire = $("#ticketrequire").val();
                const var_ticketresult = $("#ticketresult").val();

                $.ajax({
                    url: '/ticket/ticket_mycreate/',
                    type: "POST",
                    dataType: "json",
                    data: {
                        'type': type,
                        'ticketrequire': var_ticketrequire,
                        'ticketresult': var_ticketresult,
                        'ticketid': ticketid,
                        'action': action
                    },
                    success: function (response) {
                        if (response["code"] == "200") {
                            //window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
                            window.location.href = "/ticket/ticket_mycreate/";

                        } else {
                            window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
                        }
                    },
                    error: function (response) {
                        window.wxc.xcConfirm("请求数据错误！", window.wxc.xcConfirm.typeEnum.error);
                    },
                });

            } else if (type === 'operTicket') {

                $.ajax({
                    url: '/ticket/ticket_mycreate/',
                    type: "POST",
                    dataType: "json",
                    data: {
                        'type': type,
                        'ticketid': ticketid,
                        'action': action
                    },
                    success: function (response) {
                        if (response["code"] == "200") {
                            //window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
                            window.location.href = "/ticket/ticket_mycreate/"

                        } else {
                            window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
                        }
                    },
                    error: function (response) {
                        window.wxc.xcConfirm("请求数据错误！", window.wxc.xcConfirm.typeEnum.error);
                    },
                });
            }
        }
    </script>


{% endblock %}